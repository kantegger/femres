---
import InteractionButtons from './InteractionButtons';
import '../i18n/translations';
import { createT, getLocalizedPath, getLocaleFromUrl } from '../i18n/index';
import { getTopicTranslation } from '../i18n/topicsUtils';

export interface Props {
  title: string;
  titleEn?: string;
  author: string;
  description: string;
  descriptionEn?: string;
  thumbnail?: string;
  publishDate: Date;
  duration?: number;
  sourceUrl: string;
  slug: string;
  topics: string[];
  locale?: string;
}

const { title, titleEn, author, description, descriptionEn, thumbnail, publishDate, duration, sourceUrl, slug, topics, locale } = Astro.props;

// èŽ·å–å½“å‰è¯­è¨€
const currentLocale = locale || getLocaleFromUrl(Astro.url);
const t = createT(currentLocale);

// æ ¹æ®è¯­è¨€é€‰æ‹©æ˜¾ç¤ºå†…å®¹
const displayTitle = (currentLocale === 'en' && titleEn) ? titleEn : title;
const displayDescription = (currentLocale === 'en' && descriptionEn) ? descriptionEn : description;

// ç”Ÿæˆæœ¬åœ°åŒ–é“¾æŽ¥
// ç§»é™¤è¯­è¨€åŽç¼€ä»¥ç”Ÿæˆå¹²å‡€çš„URLè·¯å¾„ï¼ˆä¸Žè·¯ç”±è®¾ç½®ä¿æŒä¸€è‡´ï¼‰
const cleanSlug = slug.endsWith('-en') ? slug.slice(0, -3) : slug;
const videoLink = getLocalizedPath(`videos/${cleanSlug}`, currentLocale);

// è¯†åˆ«è§†é¢‘å¹³å°
const getPlatform = (url: string) => {
  if (url.includes('youtube.com') || url.includes('youtu.be')) {
    return { name: 'YouTube', icon: 'ðŸŽ¬', color: 'bg-red-500' };
  } else if (url.includes('bilibili.com')) {
    return { name: 'Bilibili', icon: 'ðŸ“º', color: 'bg-blue-500' };
  } else if (url.includes('vimeo.com')) {
    return { name: 'Vimeo', icon: 'ðŸŽ¥', color: 'bg-sky-500' };
  } else if (url.includes('ted.com')) {
    return { name: 'TED', icon: 'ðŸ’¡', color: 'bg-red-600' };
  } else {
    return { name: 'Video', icon: 'ðŸŽ¥', color: 'bg-gray-500' };
  }
};

const platform = getPlatform(sourceUrl);

const formatDuration = (seconds?: number) => {
  if (!seconds) return '';
  const hours = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  const secs = seconds % 60;
  if (hours > 0) {
    return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  return `${mins}:${secs.toString().padStart(2, '0')}`;
};

const formatDate = (date: Date) => {
  const now = new Date();
  const diff = now.getTime() - date.getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));

  if (currentLocale === 'en') {
    if (days < 7) return `${days} days ago`;
    if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
    if (days < 365) return `${Math.floor(days / 30)} months ago`;
    return `${Math.floor(days / 365)} years ago`;
  } else {
    if (days < 7) return `${days}å¤©å‰`;
    if (days < 30) return `${Math.floor(days / 7)}å‘¨å‰`;
    if (days < 365) return `${Math.floor(days / 30)}ä¸ªæœˆå‰`;
    return `${Math.floor(days / 365)}å¹´å‰`;
  }
};
---

<article class="group relative bg-white dark:bg-gray-800 rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden">
  <a href={videoLink} class="block">
    <!-- Thumbnail with Play Button Overlay -->
    <div class="relative aspect-video bg-gray-900 overflow-hidden">
      {thumbnail ? (
        <img
          src={thumbnail}
          alt={displayTitle}
          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
        />
      ) : (
        <div class="w-full h-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
          <span class="text-6xl text-white/80">ðŸŽ¬</span>
        </div>
      )}

      <!-- Play Button Overlay - æ‚¬åœæ—¶æ˜¾ç¤ºï¼Œå¼±åŒ–è§†è§‰å†²å‡» -->
      <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all duration-300 opacity-0 group-hover:opacity-100 flex items-center justify-center">
        <div class="w-12 h-12 bg-white/70 backdrop-blur-sm rounded-full flex items-center justify-center scale-90 group-hover:scale-100 transition-all duration-200">
          <svg class="w-6 h-6 text-gray-800 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
          </svg>
        </div>
      </div>

      <!-- Duration Badge -->
      {duration && (
        <div class="absolute bottom-2 right-2 bg-black/80 text-white text-xs font-medium px-2 py-1 rounded">
          {formatDuration(duration)}
        </div>
      )}

      <!-- Platform Badge -->
      <div class={`absolute top-2 left-2 ${platform.color} text-white text-xs font-bold px-2.5 py-1 rounded-full flex items-center gap-1`}>
        <span>{platform.icon}</span>
        <span>{platform.name}</span>
      </div>

    </div>

    <!-- Video Info -->
    <div class="p-5">
      <div class="flex items-start gap-3">
        <!-- Channel Avatar Placeholder -->
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex-shrink-0 flex items-center justify-center">
          <span class="text-white text-sm font-bold">
            {author.charAt(0).toUpperCase()}
          </span>
        </div>

        <div class="flex-1 min-w-0">
          <!-- Title -->
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1 line-clamp-2 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors">
            {displayTitle}
          </h3>

          <!-- Channel & Meta -->
          <div class="flex items-center text-sm text-gray-600 dark:text-gray-400 mb-2">
            <span class="font-medium hover:text-gray-900 dark:hover:text-gray-200">
              {author}
            </span>
            <span class="mx-2">â€¢</span>
            <span>{formatDate(publishDate)}</span>
          </div>

          <!-- Description -->
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-3 line-clamp-2">
            {displayDescription}
          </p>

          <!-- Topics -->
          <div class="flex flex-wrap gap-1.5">
            {topics.slice(0, 6).map(topic => {
              const translatedTopic = getTopicTranslation(topic, currentLocale as 'zh-CN' | 'en');
              return (
                <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-md">
                  {translatedTopic}
                </span>
              );
            })}
            {topics.length > 6 && (
              <span class="inline-block px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-500 rounded-md">
                +{topics.length - 6}
              </span>
            )}
          </div>
        </div>
      </div>

      <!-- Action Bar -->
      <div class="flex items-center justify-between mt-4 pt-3 border-t border-gray-100 dark:border-gray-700">
        <div onclick="event.stopPropagation(); event.preventDefault();">
          <InteractionButtons
            contentId={`video-${slug}`}
            contentType="video"
            client:visible
          />
        </div>

        <span class="text-purple-600 dark:text-purple-400 text-sm font-medium group-hover:underline flex items-center">
          {currentLocale === 'en' ? 'Watch Video' : 'è§‚çœ‹è§†é¢‘'}
          <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </span>
      </div>
    </div>
  </a>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>