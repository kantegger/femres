---
import Layout from '../layouts/Layout.astro';
import BookCard from '../components/BookCard.astro';
import ArticleCard from '../components/ArticleCard.astro';
import VideoCard from '../components/VideoCard.astro';
import PodcastCard from '../components/PodcastCard.astro';
import PaperCard from '../components/PaperCard.astro';
import { getCollection } from 'astro:content';

// è·å–æ‰€æœ‰å†…å®¹
const books = await getCollection('books', ({ data }) => data.status === 'published');
const articles = await getCollection('articles', ({ data }) => data.status === 'published');
const videos = await getCollection('videos', ({ data }) => data.status === 'published');
const podcasts = await getCollection('podcasts', ({ data }) => data.status === 'published');
const papers = await getCollection('papers', ({ data }) => data.status === 'published');

// åˆå¹¶æ‰€æœ‰å†…å®¹
const allContent = [
  ...books.map(item => ({ ...item, contentType: 'book' as const })),
  ...articles.map(item => ({ ...item, contentType: 'article' as const })),
  ...videos.map(item => ({ ...item, contentType: 'video' as const })),
  ...podcasts.map(item => ({ ...item, contentType: 'podcast' as const })),
  ...papers.map(item => ({ ...item, contentType: 'paper' as const }))
];

// è·å–æ‰€æœ‰ä¸»é¢˜ç”¨äºç­›é€‰
const allTopics = [...new Set(allContent.flatMap(item => item.data.topics))].sort();

// å†…å®¹ç±»å‹é…ç½®
const contentTypes = [
  { value: 'book', label: 'ä¹¦ç±', icon: 'ğŸ“š', count: books.length },
  { value: 'article', label: 'æ–‡ç« ', icon: 'ğŸ“°', count: articles.length },
  { value: 'video', label: 'è§†é¢‘', icon: 'ğŸ¥', count: videos.length },
  { value: 'podcast', label: 'æ’­å®¢', icon: 'ğŸ§', count: podcasts.length },
  { value: 'paper', label: 'è®ºæ–‡', icon: 'ğŸ“„', count: papers.length }
];

// ä¸ºæ–‡ç« æ·»åŠ ç±»å‹æ ‡è®°
const enrichedArticles = articles.map(article => {
  let articleType: 'news' | 'blog' | 'research' | 'opinion' | 'analysis' = 'blog';
  if (article.data.title.includes('æŠ¥å‘Š') || article.data.title.includes('æ•°æ®')) {
    articleType = 'analysis';
  } else if (article.data.title.includes('ç°çŠ¶') || article.data.title.includes('MeToo')) {
    articleType = 'news';
  }
  return { ...article, articleType };
});
---

<Layout title="æœç´¢ - FemRes" description="æœç´¢FemReså¹³å°ä¸Šçš„å¥³æ€§ä¸»ä¹‰å†…å®¹ï¼ŒåŒ…æ‹¬ä¹¦ç±ã€æ–‡ç« ã€è§†é¢‘ã€æ’­å®¢å’Œå­¦æœ¯è®ºæ–‡">
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- æœç´¢å¤´éƒ¨ -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="text-center mb-6 sm:mb-8">
          <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-3 sm:mb-4">
            å†…å®¹æœç´¢
          </h1>
          <p class="text-lg sm:text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto px-4">
            åœ¨ {allContent.length} ä¸ªç²¾é€‰å†…å®¹ä¸­å‘ç°æ‚¨éœ€è¦çš„å¥³æ€§ä¸»ä¹‰èµ„æº
          </p>
        </div>

        <!-- æœç´¢æ¡† -->
        <div class="max-w-3xl mx-auto mb-6 sm:mb-8 px-4">
          <div class="relative">
            <input
              type="text"
              id="searchInput"
              placeholder="æœç´¢æ ‡é¢˜ã€ä½œè€…ã€æè¿°æˆ–ä¸»é¢˜..."
              class="w-full px-4 sm:px-6 py-3 sm:py-4 pr-12 text-base sm:text-lg bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 shadow-sm"
            />
            <div class="absolute right-3 sm:right-4 top-1/2 transform -translate-y-1/2">
              <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>
        </div>

        <!-- å¿«é€Ÿç­›é€‰æ ‡ç­¾ -->
        <div class="flex flex-wrap justify-center gap-2 sm:gap-3 mb-6">
          {contentTypes.map(type => (
            <button
              class="content-type-filter px-3 sm:px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-purple-50 dark:hover:bg-gray-600 hover:border-purple-300 dark:hover:border-purple-400 transition-colors text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap"
              data-type={type.value}
            >
              <span class="mr-1 sm:mr-2">{type.icon}</span>
              <span class="hidden sm:inline">{type.label} ({type.count})</span>
              <span class="sm:hidden">{type.icon}</span>
            </button>
          ))}
          <button
            id="clearFilters"
            class="px-3 sm:px-4 py-2 bg-gray-100 dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500 transition-colors text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-400"
          >
            <span class="sm:hidden">æ¸…é™¤</span>
            <span class="hidden sm:inline">æ¸…é™¤ç­›é€‰</span>
          </button>
        </div>
      </div>
    </div>

    <!-- ç­›é€‰å’Œæ’åºæ  -->
    <div class="bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex flex-col gap-4">
          <!-- ç§»åŠ¨ç«¯ç­›é€‰å™¨ - æ°´å¹³æ»šåŠ¨ -->
          <div class="md:hidden">
            <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
              <!-- ä¸»é¢˜ç­›é€‰ -->
              <div class="relative flex-shrink-0">
                <select id="topicFilter" class="appearance-none w-40 px-3 py-2 pr-8 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm hover:border-purple-300 dark:hover:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm text-gray-900 dark:text-white transition-all duration-200 cursor-pointer">
                  <option value="">æ‰€æœ‰ä¸»é¢˜</option>
                  {allTopics.map(topic => (
                    <option value={topic}>{topic}</option>
                  ))}
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                  <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>

              <!-- è¯­è¨€ç­›é€‰ -->
              <div class="relative flex-shrink-0">
                <select id="languageFilter" class="appearance-none w-32 px-3 py-2 pr-8 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm hover:border-purple-300 dark:hover:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm text-gray-900 dark:text-white transition-all duration-200 cursor-pointer">
                  <option value="">è¯­è¨€</option>
                  <option value="zh-CN">ä¸­æ–‡</option>
                  <option value="en">English</option>
                  <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                  <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                  </svg>
                </div>
              </div>

              <!-- æ’åº -->
              <div class="relative flex-shrink-0">
                <select id="sortBy" class="appearance-none w-28 px-3 py-2 pr-8 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-sm hover:border-purple-300 dark:hover:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm text-gray-900 dark:text-white transition-all duration-200 cursor-pointer">
                  <option value="relevance">ç›¸å…³åº¦</option>
                  <option value="date-desc">æœ€æ–°</option>
                  <option value="date-asc">æœ€æ—©</option>
                  <option value="title-asc">A-Z</option>
                  <option value="title-desc">Z-A</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                  <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                  </svg>
                </div>
              </div>
            </div>
            
            <!-- ç§»åŠ¨ç«¯ç»“æœæ•°é‡ -->
            <div class="text-center mt-2">
              <span id="resultsCountMobile" class="text-sm text-gray-600 dark:text-gray-400">
                æ˜¾ç¤º {allContent.length} ä¸ªç»“æœ
              </span>
            </div>
          </div>

          <!-- æ¡Œé¢ç«¯ç­›é€‰å™¨ -->
          <div class="hidden md:flex md:items-center md:justify-between gap-4">
            <div class="flex gap-4">
              <!-- ä¸»é¢˜ç­›é€‰ -->
              <div class="relative">
                <select id="topicFilterDesktop" class="appearance-none w-48 px-4 py-3 pr-10 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl shadow-sm hover:border-purple-300 dark:hover:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm text-gray-900 dark:text-white transition-all duration-200 cursor-pointer">
                  <option value="">æ‰€æœ‰ä¸»é¢˜</option>
                  {allTopics.map(topic => (
                    <option value={topic}>{topic}</option>
                  ))}
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>

              <!-- è¯­è¨€ç­›é€‰ -->
              <div class="relative">
                <select id="languageFilterDesktop" class="appearance-none w-40 px-4 py-3 pr-10 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl shadow-sm hover:border-purple-300 dark:hover:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm text-gray-900 dark:text-white transition-all duration-200 cursor-pointer">
                  <option value="">æ‰€æœ‰å†…å®¹è¯­è¨€</option>
                  <option value="zh-CN">ä¸­æ–‡</option>
                  <option value="en">English</option>
                  <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                  </svg>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-4">
              <!-- æ’åº -->
              <div class="relative">
                <select id="sortByDesktop" class="appearance-none w-36 px-4 py-3 pr-10 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl shadow-sm hover:border-purple-300 dark:hover:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm text-gray-900 dark:text-white transition-all duration-200 cursor-pointer">
                  <option value="relevance">ç›¸å…³åº¦</option>
                  <option value="date-desc">æœ€æ–°å‘å¸ƒ</option>
                  <option value="date-asc">æœ€æ—©å‘å¸ƒ</option>
                  <option value="title-asc">æ ‡é¢˜ A-Z</option>
                  <option value="title-desc">æ ‡é¢˜ Z-A</option>
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                  </svg>
                </div>
              </div>

              <!-- ç»“æœæ•°é‡æ˜¾ç¤º -->
              <span id="resultsCountDesktop" class="text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">
                æ˜¾ç¤º {allContent.length} ä¸ªç»“æœ
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æœç´¢ç»“æœ -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- æ— ç»“æœæç¤º -->
      <div id="noResults" class="text-center py-12 hidden">
        <div class="text-gray-400 dark:text-gray-500 text-6xl mb-4">ğŸ”</div>
        <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</h3>
        <p class="text-gray-500 dark:text-gray-400">è¯·å°è¯•è°ƒæ•´æœç´¢è¯æˆ–ç­›é€‰æ¡ä»¶</p>
      </div>

      <!-- ç»“æœç½‘æ ¼ -->
      <div id="searchResults" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
        <!-- ä¹¦ç±ç»“æœ -->
        {books.map(book => (
          <div class="search-item" data-type="book" data-title={book.data.title.toLowerCase()} data-author={book.data.author.toLowerCase()} data-description={book.data.description.toLowerCase()} data-topics={book.data.topics.join(' ').toLowerCase()} data-language={book.data.contentLanguage} data-date={book.data.publishDate.getTime()}>
            <BookCard
              title={book.data.title}
              author={book.data.author}
              description={book.data.description}
              coverImage={book.data.coverImage}
              publishDate={book.data.publishDate}
              slug={book.slug}
              topics={book.data.topics}
              isbn={book.data.isbn}
            />
          </div>
        ))}

        <!-- æ–‡ç« ç»“æœ -->
        {enrichedArticles.map(article => (
          <div class="search-item" data-type="article" data-title={article.data.title.toLowerCase()} data-author={article.data.author.toLowerCase()} data-description={article.data.description.toLowerCase()} data-topics={article.data.topics.join(' ').toLowerCase()} data-language={article.data.contentLanguage} data-date={article.data.publishDate.getTime()}>
            <ArticleCard
              title={article.data.title}
              author={article.data.author}
              description={article.data.description}
              featuredImage={article.data.featuredImage}
              publishDate={article.data.publishDate}
              readingTime={article.data.readingTime}
              sourceUrl={article.data.sourceUrl}
              slug={article.slug}
              topics={article.data.topics}
              articleType={article.articleType}
            />
          </div>
        ))}

        <!-- è§†é¢‘ç»“æœ -->
        {videos.map(video => (
          <div class="search-item" data-type="video" data-title={video.data.title.toLowerCase()} data-author={video.data.author.toLowerCase()} data-description={video.data.description.toLowerCase()} data-topics={video.data.topics.join(' ').toLowerCase()} data-language={video.data.contentLanguage} data-date={video.data.publishDate.getTime()}>
            <VideoCard
              title={video.data.title}
              author={video.data.author}
              description={video.data.description}
              thumbnail={video.data.thumbnail}
              publishDate={video.data.publishDate}
              duration={video.data.duration}
              sourceUrl={video.data.sourceUrl}
              slug={video.slug}
              topics={video.data.topics}
            />
          </div>
        ))}

        <!-- æ’­å®¢ç»“æœ -->
        {podcasts.map(podcast => (
          <div class="search-item" data-type="podcast" data-title={podcast.data.title.toLowerCase()} data-author={podcast.data.author.toLowerCase()} data-description={podcast.data.description.toLowerCase()} data-topics={podcast.data.topics.join(' ').toLowerCase()} data-language={podcast.data.contentLanguage} data-date={podcast.data.publishDate.getTime()}>
            <PodcastCard
              title={podcast.data.title}
              author={podcast.data.author}
              description={podcast.data.description}
              thumbnail={podcast.data.thumbnail}
              publishDate={podcast.data.publishDate}
              duration={podcast.data.duration}
              sourceUrl={podcast.data.sourceUrl}
              slug={podcast.slug}
              topics={podcast.data.topics}
              episodeNumber={podcast.data.episodeNumber}
            />
          </div>
        ))}

        <!-- è®ºæ–‡ç»“æœ -->
        {papers.map(paper => (
          <div class="search-item" data-type="paper" data-title={paper.data.title.toLowerCase()} data-author={paper.data.author.toLowerCase()} data-description={paper.data.description.toLowerCase()} data-topics={paper.data.topics.join(' ').toLowerCase()} data-language={paper.data.contentLanguage} data-date={paper.data.publishDate.getTime()}>
            <PaperCard
              title={paper.data.title}
              author={paper.data.author}
              description={paper.data.description}
              publishDate={paper.data.publishDate}
              slug={paper.slug}
              topics={paper.data.topics}
              journal={paper.data.journal}
              doi={paper.data.doi}
              citationCount={paper.data.citationCount}
              paperType={paper.data.paperType}
            />
          </div>
        ))}
      </div>
    </div>
  </div>

  <script>
    // æœç´¢å’Œç­›é€‰åŠŸèƒ½
    class ContentSearch {
      constructor() {
        this.searchInput = document.getElementById('searchInput') as HTMLInputElement;
        // ç§»åŠ¨ç«¯ç­›é€‰å™¨
        this.topicFilter = document.getElementById('topicFilter') as HTMLSelectElement;
        this.languageFilter = document.getElementById('languageFilter') as HTMLSelectElement;
        this.sortBy = document.getElementById('sortBy') as HTMLSelectElement;
        this.resultsCountMobile = document.getElementById('resultsCountMobile') as HTMLElement;
        // æ¡Œé¢ç«¯ç­›é€‰å™¨
        this.topicFilterDesktop = document.getElementById('topicFilterDesktop') as HTMLSelectElement;
        this.languageFilterDesktop = document.getElementById('languageFilterDesktop') as HTMLSelectElement;
        this.sortByDesktop = document.getElementById('sortByDesktop') as HTMLSelectElement;
        this.resultsCountDesktop = document.getElementById('resultsCountDesktop') as HTMLElement;
        // é€šç”¨å…ƒç´ 
        this.noResults = document.getElementById('noResults') as HTMLElement;
        this.searchResults = document.getElementById('searchResults') as HTMLElement;
        this.clearFiltersBtn = document.getElementById('clearFilters') as HTMLButtonElement;
        this.contentTypeFilters = document.querySelectorAll('.content-type-filter') as NodeListOf<HTMLButtonElement>;
        
        this.allItems = Array.from(document.querySelectorAll('.search-item')) as HTMLElement[];
        this.activeContentTypes = new Set<string>();
        
        this.bindEvents();
        this.updateResults();
      }
      
      bindEvents() {
        // æœç´¢è¾“å…¥
        this.searchInput?.addEventListener('input', () => this.updateResults());
        
        // ç§»åŠ¨ç«¯ç­›é€‰å™¨
        this.topicFilter?.addEventListener('change', () => {
          if (this.topicFilterDesktop) this.topicFilterDesktop.value = this.topicFilter.value;
          this.updateResults();
        });
        this.languageFilter?.addEventListener('change', () => {
          if (this.languageFilterDesktop) this.languageFilterDesktop.value = this.languageFilter.value;
          this.updateResults();
        });
        this.sortBy?.addEventListener('change', () => {
          if (this.sortByDesktop) this.sortByDesktop.value = this.sortBy.value;
          this.updateResults();
        });
        
        // æ¡Œé¢ç«¯ç­›é€‰å™¨
        this.topicFilterDesktop?.addEventListener('change', () => {
          if (this.topicFilter) this.topicFilter.value = this.topicFilterDesktop.value;
          this.updateResults();
        });
        this.languageFilterDesktop?.addEventListener('change', () => {
          if (this.languageFilter) this.languageFilter.value = this.languageFilterDesktop.value;
          this.updateResults();
        });
        this.sortByDesktop?.addEventListener('change', () => {
          if (this.sortBy) this.sortBy.value = this.sortByDesktop.value;
          this.updateResults();
        });
        
        // å†…å®¹ç±»å‹ç­›é€‰
        this.contentTypeFilters?.forEach(btn => {
          btn.addEventListener('click', () => this.toggleContentType(btn));
        });
        
        // æ¸…é™¤ç­›é€‰
        this.clearFiltersBtn?.addEventListener('click', () => this.clearFilters());
        
        // URLå‚æ•°å¤„ç†
        this.handleURLParams();
      }
      
      toggleContentType(button: HTMLButtonElement) {
        const type = button.dataset.type;
        if (!type) return;
        
        if (this.activeContentTypes.has(type)) {
          this.activeContentTypes.delete(type);
          button.classList.remove('bg-purple-100', 'dark:bg-purple-900', 'border-purple-300', 'dark:border-purple-600', 'text-purple-700', 'dark:text-purple-300');
          button.classList.add('bg-white', 'dark:bg-gray-700', 'border-gray-300', 'dark:border-gray-600', 'text-gray-700', 'dark:text-gray-300');
        } else {
          this.activeContentTypes.add(type);
          button.classList.add('bg-purple-100', 'dark:bg-purple-900', 'border-purple-300', 'dark:border-purple-600', 'text-purple-700', 'dark:text-purple-300');
          button.classList.remove('bg-white', 'dark:bg-gray-700', 'border-gray-300', 'dark:border-gray-600', 'text-gray-700', 'dark:text-gray-300');
        }
        
        this.updateResults();
      }
      
      clearFilters() {
        this.searchInput.value = '';
        // ç§»åŠ¨ç«¯ç­›é€‰å™¨
        if (this.topicFilter) this.topicFilter.value = '';
        if (this.languageFilter) this.languageFilter.value = '';
        if (this.sortBy) this.sortBy.value = 'relevance';
        // æ¡Œé¢ç«¯ç­›é€‰å™¨
        if (this.topicFilterDesktop) this.topicFilterDesktop.value = '';
        if (this.languageFilterDesktop) this.languageFilterDesktop.value = '';
        if (this.sortByDesktop) this.sortByDesktop.value = 'relevance';
        
        this.activeContentTypes.clear();
        
        // é‡ç½®å†…å®¹ç±»å‹æŒ‰é’®æ ·å¼
        this.contentTypeFilters.forEach(btn => {
          btn.classList.remove('bg-purple-100', 'dark:bg-purple-900', 'border-purple-300', 'dark:border-purple-600', 'text-purple-700', 'dark:text-purple-300');
          btn.classList.add('bg-white', 'dark:bg-gray-700', 'border-gray-300', 'dark:border-gray-600', 'text-gray-700', 'dark:text-gray-300');
        });
        
        this.updateResults();
      }
      
      handleURLParams() {
        const params = new URLSearchParams(window.location.search);
        const query = params.get('q');
        const type = params.get('type');
        const topic = params.get('topic');
        
        if (query) this.searchInput.value = query;
        if (type) {
          this.activeContentTypes.add(type);
          const button = document.querySelector(`[data-type="${type}"]`) as HTMLButtonElement;
          if (button) this.toggleContentType(button);
        }
        if (topic) {
          if (this.topicFilter) this.topicFilter.value = topic;
          if (this.topicFilterDesktop) this.topicFilterDesktop.value = topic;
        }
        
        this.updateResults();
      }
      
      updateResults() {
        const query = this.searchInput.value.toLowerCase().trim();
        const selectedTopic = this.topicFilter?.value || this.topicFilterDesktop?.value || '';
        const selectedLanguage = this.languageFilter?.value || this.languageFilterDesktop?.value || '';
        const sortBy = this.sortBy?.value || this.sortByDesktop?.value || 'relevance';
        
        let filteredItems = this.allItems.filter(item => {
          // æœç´¢åŒ¹é…
          if (query) {
            const title = item.dataset.title || '';
            const author = item.dataset.author || '';
            const description = item.dataset.description || '';
            const topics = item.dataset.topics || '';
            
            if (!title.includes(query) && !author.includes(query) && 
                !description.includes(query) && !topics.includes(query)) {
              return false;
            }
          }
          
          // å†…å®¹ç±»å‹ç­›é€‰
          if (this.activeContentTypes.size > 0) {
            const itemType = item.dataset.type;
            if (!itemType || !this.activeContentTypes.has(itemType)) {
              return false;
            }
          }
          
          // ä¸»é¢˜ç­›é€‰
          if (selectedTopic) {
            const topics = item.dataset.topics || '';
            if (!topics.includes(selectedTopic.toLowerCase())) {
              return false;
            }
          }
          
          // è¯­è¨€ç­›é€‰
          if (selectedLanguage) {
            const language = item.dataset.language || '';
            if (language !== selectedLanguage) {
              return false;
            }
          }
          
          return true;
        });
        
        // æ’åº
        this.sortResults(filteredItems, sortBy);
        
        // æ˜¾ç¤ºç»“æœ
        this.displayResults(filteredItems);
        
        // æ›´æ–°è®¡æ•°
        if (this.resultsCountMobile) this.resultsCountMobile.textContent = `æ˜¾ç¤º ${filteredItems.length} ä¸ªç»“æœ`;
        if (this.resultsCountDesktop) this.resultsCountDesktop.textContent = `æ˜¾ç¤º ${filteredItems.length} ä¸ªç»“æœ`;
      }
      
      sortResults(items: HTMLElement[], sortBy: string) {
        items.sort((a, b) => {
          switch (sortBy) {
            case 'date-desc':
              return Number(b.dataset.date) - Number(a.dataset.date);
            case 'date-asc':
              return Number(a.dataset.date) - Number(b.dataset.date);
            case 'title-asc':
              return (a.dataset.title || '').localeCompare(b.dataset.title || '');
            case 'title-desc':
              return (b.dataset.title || '').localeCompare(a.dataset.title || '');
            default: // relevance
              return 0;
          }
        });
      }
      
      displayResults(filteredItems: HTMLElement[]) {
        // éšè—æ‰€æœ‰é¡¹ç›®
        this.allItems.forEach(item => {
          item.style.display = 'none';
        });
        
        // æ˜¾ç¤ºç­›é€‰åçš„é¡¹ç›®
        filteredItems.forEach(item => {
          item.style.display = 'block';
        });
        
        // é‡æ–°æ’åˆ—DOMé¡ºåº
        filteredItems.forEach(item => {
          this.searchResults.appendChild(item);
        });
        
        // æ˜¾ç¤º/éšè—æ— ç»“æœæç¤º
        if (filteredItems.length === 0) {
          this.noResults.classList.remove('hidden');
          this.searchResults.classList.add('hidden');
        } else {
          this.noResults.classList.add('hidden');
          this.searchResults.classList.remove('hidden');
        }
      }
    }
    
    // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', () => {
      new ContentSearch();
    });
  </script>
</Layout>