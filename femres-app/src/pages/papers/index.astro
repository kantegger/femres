---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import PaperCard from '../../components/PaperCard.astro';
import { createT } from '../../i18n';
import { getTopicTranslation, findTopicByName } from '../../i18n/topicsUtils';

// è·å–æ‰€æœ‰å·²å‘å¸ƒçš„è®ºæ–‡
const papers = await getCollection('papers', ({ data }) => data.status === 'published');

// æŒ‰å‘å¸ƒæ—¥æœŸæ’åº
const sortedPapers = papers.sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime());

// ç»Ÿè®¡ä¿¡æ¯
const totalPapers = papers.length;
const totalCitations = papers.reduce((acc, paper) => acc + (paper.data.citationCount || 0), 0);

// è·å–æ‰€æœ‰ä¸»é¢˜å¹¶å»é‡
const allTopics = [...new Set(papers.flatMap(paper => paper.data.topics))].sort();

// è®¾ç½®å½“å‰è¯­è¨€å’Œç¿»è¯‘å‡½æ•°
const currentLocale = 'zh-CN';
const t = createT(currentLocale);

// è®ºæ–‡ç±»å‹ç»Ÿè®¡
const paperTypes = papers.reduce((acc, paper) => {
  const type = paper.data.paperType || 'research';
  acc[type] = (acc[type] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

// æœŸåˆŠç»Ÿè®¡
const journalCount = new Set(papers.map(paper => paper.data.journal).filter(Boolean)).size;

// æ ¼å¼åŒ–æ•°å­—
const formatNumber = (num: number) => {
  if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K';
  }
  return num.toString();
};
---

<Layout title="å­¦æœ¯è®ºæ–‡ - FemRes" description="æ±‡èšå¥³æ€§ä¸»ä¹‰å­¦æœ¯ç ”ç©¶çš„å‰æ²¿è®ºæ–‡ï¼Œæ¢ç´¢æ€§åˆ«ç ”ç©¶çš„ç†è®ºå‘å±•ä¸å®è·µåº”ç”¨">
  <!-- Hero Section -->
  <div class="relative overflow-hidden text-white border-b border-white/20">
    <!-- Gradient Background Layer -->
    <div class="absolute inset-0 bg-gradient-to-r from-slate-600 to-gray-600" style="filter: saturate(1.3) contrast(1.15);"></div>
    <!-- ç²—ç£¨ç ‚çº¹ç†å±‚ -->
    <div class="absolute inset-0 opacity-65" style="background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.5) 1px, transparent 0); background-size: 12px 12px;"></div>
    <!-- ä¸­ç­‰ç£¨ç ‚çº¹ç†å±‚ -->
    <div class="absolute inset-0 opacity-45" style="background-image: radial-gradient(circle at 0.8px 0.8px, rgba(255,255,255,0.7) 0.8px, transparent 0); background-size: 6px 6px;"></div>
    <!-- ç»†ç£¨ç ‚çº¹ç†å±‚ -->
    <div class="absolute inset-0 opacity-35" style="background-image: radial-gradient(circle at 0.3px 0.3px, rgba(255,255,255,0.8) 0.3px, transparent 0); background-size: 3px 3px;"></div>
    <!-- ä¿æŒç°æœ‰çš„ç»ç’ƒå åŠ å±‚ -->
    <div class="absolute inset-0 bg-white/10 backdrop-blur-sm"></div>
    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(255,255,255,0.1),transparent)]"></div>
    <div class="relative z-10">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <div class="relative backdrop-blur-sm">
          <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">
              ğŸ“„ å­¦æœ¯è®ºæ–‡
            </h1>
            <p class="text-xl opacity-90 mb-8 max-w-2xl mx-auto">
              æ±‡èšå¥³æ€§ä¸»ä¹‰å­¦æœ¯ç ”ç©¶çš„å‰æ²¿æˆæœï¼Œæ¢ç´¢æ€§åˆ«ç ”ç©¶çš„ç†è®ºåˆ›æ–°ä¸å®è¯åˆ†æ
            </p>

            <!-- Statistics -->
            <div class="flex flex-wrap justify-center gap-6 text-sm">
              <div class="flex items-center bg-white/15 backdrop-blur-md border border-white/20 shadow-lg shadow-black/10 px-4 py-2 rounded-full">
                <span class="text-white mr-2">ğŸ“„</span>
                <span class="text-white">å…± {totalPapers} ç¯‡è®ºæ–‡</span>
              </div>
              <div class="flex items-center bg-white/15 backdrop-blur-md border border-white/20 shadow-lg shadow-black/10 px-4 py-2 rounded-full">
                <span class="text-white mr-2">ğŸ“Š</span>
                <span class="text-white">æ€»å¼•ç”¨ {formatNumber(totalCitations)} æ¬¡</span>
              </div>
              <div class="flex items-center bg-white/15 backdrop-blur-md border border-white/20 shadow-lg shadow-black/10 px-4 py-2 rounded-full">
                <span class="text-white mr-2">ğŸ“š</span>
                <span class="text-white">{journalCount} ä¸ªæœŸåˆŠ</span>
              </div>
              <div class="flex items-center bg-white/15 backdrop-blur-md border border-white/20 shadow-lg shadow-black/10 px-4 py-2 rounded-full">
                <span class="text-white mr-2">ğŸ·ï¸</span>
                <span class="text-white">{allTopics.length} ä¸ªç ”ç©¶é¢†åŸŸ</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    
    <!-- ä¸»é¢˜æ ‡ç­¾ç­›é€‰ -->
    <div class="mb-12">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">ç ”ç©¶é¢†åŸŸ</h2>
      <div class="relative">
        <!-- ä¸»é¢˜æ ‡ç­¾å®¹å™¨ -->
        <div id="topics-container" class="flex flex-wrap gap-3 overflow-hidden transition-all duration-300" style="max-height: 90px;">
          <button 
            data-topic="all"
            class="topic-filter inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium active"
          >
            å…¨éƒ¨è®ºæ–‡
          </button>
          {allTopics.map(topic => {
            const topicInfo = findTopicByName(topic);
            const translatedTopic = topicInfo
              ? getTopicTranslation(topic, currentLocale as 'zh-CN' | 'en')
              : topic;
            return (
              <button
                data-topic={topic}
                class="topic-filter inline-flex items-center px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:border-amber-500 dark:hover:border-amber-400 hover:text-amber-600 dark:hover:text-amber-400 transition-colors text-sm"
              >
                {translatedTopic}
              </button>
            );
          })}
        </div>
        
        <!-- å±•å¼€/æŠ˜å æŒ‰é’® - åªåœ¨éœ€è¦æ—¶æ˜¾ç¤º -->
        {allTopics.length > 20 && (
          <div class="flex justify-center mt-4">
            <button 
              id="toggle-topics-btn"
              class="inline-flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400 rounded-lg transition-colors text-sm font-medium"
            >
              <span id="toggle-topics-text">å±•å¼€æ›´å¤šä¸»é¢˜</span>
              <svg id="toggle-topics-icon" class="ml-2 w-4 h-4 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
          </div>
        )}
      </div>
    </div>


    <!-- è®ºæ–‡ç½‘æ ¼ -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">å…¨éƒ¨è®ºæ–‡</h2>
        <div class="text-sm text-gray-600 dark:text-gray-400">
          å…± {totalPapers} ç¯‡è®ºæ–‡
        </div>
      </div>
      
      <div id="papers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {sortedPapers.map(paper => (
          <div class="paper-card" data-topics={JSON.stringify(paper.data.topics)}>
            <PaperCard
              title={paper.data.title}
              author={paper.data.author}
              description={paper.data.description}
              publishDate={paper.data.publishDate}
              sourceUrl={paper.data.sourceUrl}
              slug={paper.slug}
              topics={paper.data.topics}
              doi={paper.data.doi}
              journal={paper.data.journal}
              citationCount={paper.data.citationCount}
              paperType={paper.data.paperType}
              keywords={paper.data.keywords}
            />
          </div>
        ))}
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.topic-filter');
    const paperCards = document.querySelectorAll('.paper-card');
    const countDisplay = document.querySelector('.text-sm.text-gray-600.dark\\:text-gray-400');
    const sectionTitle = document.querySelector('.mb-8 h2');
    
    // ä¸»é¢˜å±•å¼€/æŠ˜å åŠŸèƒ½
    const topicsContainer = document.getElementById('topics-container');
    const toggleBtn = document.getElementById('toggle-topics-btn');
    const toggleText = document.getElementById('toggle-topics-text');
    const toggleIcon = document.getElementById('toggle-topics-icon');
    let isTopicsExpanded = false;
    
    // åªåœ¨æŒ‰é’®å­˜åœ¨æ—¶æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    if (toggleBtn) {
      toggleBtn.addEventListener('click', function() {
        if (isTopicsExpanded) {
          // æŠ˜å ä¸»é¢˜
          topicsContainer.style.maxHeight = '90px'; // çº¦2è¡Œé«˜åº¦
          toggleText.textContent = 'å±•å¼€æ›´å¤šä¸»é¢˜';
          toggleIcon.style.transform = 'rotate(0deg)';
          isTopicsExpanded = false;
        } else {
          // å±•å¼€ä¸»é¢˜
          topicsContainer.style.maxHeight = 'none';
          toggleText.textContent = 'æ”¶èµ·ä¸»é¢˜';
          toggleIcon.style.transform = 'rotate(180deg)';
          isTopicsExpanded = true;
        }
      });
    }
    
    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        const selectedTopic = this.dataset.topic;
        
        // Update active button
        filterButtons.forEach(btn => {
          btn.classList.remove('active', 'bg-indigo-600', 'text-white');
          btn.classList.add('bg-white', 'dark:bg-gray-800', 'border', 'border-gray-300', 'dark:border-gray-600', 'text-gray-700', 'dark:text-gray-300');
        });
        
        this.classList.add('active', 'bg-indigo-600', 'text-white');
        this.classList.remove('bg-white', 'dark:bg-gray-800', 'border', 'border-gray-300', 'dark:border-gray-600', 'text-gray-700', 'dark:text-gray-300');
        
        // Filter papers
        let visibleCount = 0;
        paperCards.forEach(card => {
          const topics = JSON.parse(card.dataset.topics);
          const shouldShow = selectedTopic === 'all' || topics.includes(selectedTopic);
          
          if (shouldShow) {
            card.style.display = 'block';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });
        
        // Update count display
        if (countDisplay) {
          countDisplay.textContent = `å…± ${visibleCount} ç¯‡è®ºæ–‡`;
        }
        
        // Update section title
        if (sectionTitle) {
          sectionTitle.textContent = selectedTopic === 'all' ? 'å…¨éƒ¨è®ºæ–‡' : `${selectedTopic} è®ºæ–‡`;
        }
      });
    });
  });
</script>

<style>
  .topic-filter.active {
    background-color: rgb(79 70 229) !important;
    color: white !important;
    border: none !important;
  }
</style>